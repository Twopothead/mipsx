// #include "mipsx.h"
#include <inttypes.h>
#include <stdio.h>
#include <cstring>
#include <stdlib.h>
#include "cmipsx.h"
#include "monitor.h"
// http://emulation.gametechwiki.com/index.php/PS1_Tests
// PS1 Test:https://psx.amidog.se/doku.php?id=psx:download:misc
// https://www.ngemu.com/threads/pcsx-issues.143000/
int recode_cycle = 20;
// syscall 
// [2695642] 0xbfc0d964 0x0000000c
// [2766784] 0x8005aa94 0x0000000c
// lwl 24502246
// 0xbfc00000	0x88c10003	lwl  R01, [R06 + 0x3]
// 到15000000为止，pc和IR都不错
// 19246121出问题了
// 正确[19246538] 0x80052a30 0x00004012
// [19246541] 0x80052a30 0x00004012
// [19246537] 0x80052a2c 0x00c1001a

// [19246537] 0x80052a2c 0x00c1001a 0x00c1001a	div R06, R01
// PSX HI=0x0000005e LO=0x00005ebc
// GPR00: r0 00000000 at 0000000c v0 00000024 v1 0000003c
// GPR04: a0 00000003 a1 00000000 a2 00000024 a3 00000063
// GPR08: t0 1f801c00 t1 00000000 t2 0000dff1 t3 00000000
// GPR12: t4 00000200 t5 800699e0 t6 1f801c00 t7 800697e0
// GPR16: s0 00000000 s1 00000000 s2 00000002 s3 00000001
// GPR20: s4 00000000 s5 800dea68 s6 00000001 s7 00000000
// GPR24: t8 0000dff1 t9 1f801c00 k0 8005aa18 k1 00000f1c
// GPR28: gp a0010ff0 sp 801ffc28 s8 00000024 ra 80052fe0
// [19246538] 0x80052a30 0x00004012 0x00004012	mflo R08
// PSX HI=0000000000 LO=0x00000003
// GPR00: r0 00000000 at 0000000c v0 00000024 v1 0000003c
// GPR04: a0 00000003 a1 00000000 a2 00000024 a3 00000063
// GPR08: t0 1f801c00 t1 00000000 t2 0000dff1 t3 00000000
// GPR12: t4 00000200 t5 800699e0 t6 1f801c00 t7 800697e0
// GPR16: s0 00000000 s1 00000000 s2 00000002 s3 00000001
// GPR20: s4 00000000 s5 800dea68 s6 00000001 s7 00000000
// GPR24: t8 0000dff1 t9 1f801c00 k0 8005aa18 k1 00000f1c
// GPR28: gp a0010ff0 sp 801ffc28 s8 00000024 ra 80052fe0
// [19246539] 0x80052a34 0x30aeffff
// PSX HI=0000000000 LO=0x00000003
// GPR00: r0 00000000 at 0000000c v0 00000024 v1 0000003c
// GPR04: a0 00000003 a1 00000000 a2 00000024 a3 00000063
// GPR08: t0 00000003 t1 00000000 t2 0000dff1 t3 00000000
// GPR12: t4 00000200 t5 800699e0 t6 1f801c00 t7 800697e0
// GPR16: s0 00000000 s1 00000000 s2 00000002 s3 00000001
// GPR20: s4 00000000 s5 800dea68 s6 00000001 s7 00000000
// GPR24: t8 0000dff1 t9 1f801c00 k0 8005aa18 k1 00000f1c
// GPR28: gp a0010ff0 sp 801ffc28 s8 00000024 ra 80052fe0
// 前200000个里面，寄存器确保都正确
// 到19246571，寄存器都正确
// 24502251 0x88c10003
// OK [19202245] 0x80054168 0x030fc023
// [19222245] 0x80054178 0x27280001
// OK [19248870] 0x00000c84 0x00000000
// [19282255] 0x80059e08 0x0105082a
// 19258608可能是分界
// [19258626] 0xbfc04168 0x1720000e还是正确的
int main()
{
    MIPSX_SYSTEM psx;
    Monitor monitor(psx); 
    const int total_cycle =19258619;
    for( mipsx_cycle=-2;mipsx_cycle<=total_cycle+1;mipsx_cycle++)
    {   
        if(mipsx_cycle>=19258618){
            Log::log = true;
        }
        psx.tick();
        if(Log::log)
            monitor.showStatus();
    }
    x__err("[19258618] 0x8cce0000	lw  R14, [R06 + 0x0]\n这里出错了,此时R14是0x1f801814,这里是从GPU加载状态,然而,现在GPU没有实现");
    
   
    return 0;
}
//真正出错的地方在19258628,以下为正解
// 	0x8cce0000	lw  R14, [R06 + 0x0]
// 1f801814关键是GPU GP0的相关指令没有implement
// [19258626] 0xbfc04168 0x1720000e
// PSX HI=0x0000066d LO=0x00000594
// GPR00: r0 00000000 at 60000000 v0 00000000 v1 10000000
// GPR04: a0 10000000 a1 80050dac a2 1f801814 a3 00000008
// GPR08: t0 bfc03fac t1 00000124 t2 000000a0 t3 00000009
// GPR12: t4 00000023 t5 0000002b t6 1c802000 t7 00000000
// GPR16: s0 00000000 s1 00000000 s2 00000000 s3 00000000
// GPR20: s4 00000000 s5 00000000 s6 00000000 s7 00000000
// GPR24: t8 1c802000 t9 10000000 k0 8005aa18 k1 00000f1c
// GPR28: gp a0010ff0 sp 801ffce8 s8 801fff00 ra bfc03fbc
// [19258627] 0xbfc0416c 0x00000000
// PSX HI=0x0000066d LO=0x00000594
// GPR00: r0 00000000 at 60000000 v0 00000000 v1 10000000
// GPR04: a0 10000000 a1 80050dac a2 1f801814 a3 00000008
// GPR08: t0 bfc03fac t1 00000124 t2 000000a0 t3 00000009
// GPR12: t4 00000023 t5 0000002b t6 1c802000 t7 00000000
// GPR16: s0 00000000 s1 00000000 s2 00000000 s3 00000000
// GPR20: s4 00000000 s5 00000000 s6 00000000 s7 00000000
// GPR24: t8 1c802000 t9 10000000 k0 8005aa18 k1 00000f1c
// GPR28: gp a0010ff0 sp 801ffce8 s8 801fff00 ra bfc03fbc
// [19258628] 0xbfc041a4 0x1000002a
// PSX HI=0x0000066d LO=0x00000594
// GPR00: r0 00000000 at 60000000 v0 00000000 v1 10000000
// GPR04: a0 10000000 a1 80050dac a2 1f801814 a3 00000008
// GPR08: t0 bfc03fac t1 00000124 t2 000000a0 t3 00000009
// GPR12: t4 00000023 t5 0000002b t6 1c802000 t7 00000000
// GPR16: s0 00000000 s1 00000000 s2 00000000 s3 00000000
// GPR20: s4 00000000 s5 00000000 s6 00000000 s7 00000000
// GPR24: t8 1c802000 t9 10000000 k0 8005aa18 k1 00000f1c
// GPR28: gp a0010ff0 sp 801ffce8 s8 801fff00 ra bfc03fbc

// PS-X Realtime Kernel Ver.2.5
// Copyright 1993,1994 (C) Sony Computer Entertainment Inc. 
// KERNEL SETUP!

// Configuration : EvCB	0x10		TCB	0x04
// System ROM Version 2.2 12/04/95 A
// Copyright 1993,1994,1995 (C) Sony Computer Entertainment Inc.
// ResetCallback: _96_remove ..
// VSync: timeout (1:0)
// VSync: timeout (1:0)
// VSync: timeout (1:0)
// VSync: timeout (1:0)
// VSync: timeout (1:0)
// VSync: timeout (1:0)
// VSync: timeout (1:0)
// VSync: timeout (1:0)